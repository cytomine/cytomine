apiVersion: v1
kind: Pod
metadata:
  name: "e2e-tests"
  labels:
  annotations:
    "helm.sh/hook": test
spec:
  securityContext:
  {{- include "cytomine.podSecurityContext" . | nindent 4 }}
  volumes:
    - name: tmp
      emptyDir: {}
    - name: workspace
      emptyDir: {}
  containers:
    - name: e2e-tests
      image: "{{ .Values.images.e2e_tests }}"
      securityContext:
      {{- include "cytomine.containerSecurityContext" . | nindent 8 }}
      volumeMounts:
      - name: tmp
        mountPath: /tmp/gradle
      - name: workspace
        mountPath: /workspace
      env:
        - name: CYTOMINE_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: cytomine-admin-iam-secret
              key: password
        - name: CYTOMINE_ADMIN_USERNAME
          value: admin
        - name: CYTOMINE_URL
          value: core.{{ .Release.Namespace }}.svc.cluster.local
        - name: SELENIUM_URL
          value: selenium.{{ .Release.Namespace }}.svc.cluster.local
  restartPolicy: Never
---

apiVersion: v1
kind: Deployment
metadata:
  name: e2e-tests-selenium
  labels:
  annotations:
    "helm.sh/hook": test
spec:
  replicas: 1
  selector:
    matchLabels:
      app: selenium
  template:
    metadata:
      labels:
        app: selenium
    spec:
      securityContext:
      {{- include "cytomine.podSecurityContext" . | nindent 8 }}
      containers:
        - name: selenium
          image: selenium/standalone-firefox
          securityContext:
          {{- include "cytomine.containerSecurityContext" . | nindent 10 }}
