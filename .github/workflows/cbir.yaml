name: CBIR

on:
  workflow_call:

permissions:
  contents: read

defaults:
  run:
    working-directory: ./cbir

# Hardcoded for compatibility
env:
  PYTHON_VERSION: "3.10"

jobs:
  lint:
    runs-on: self-hosted

    steps:
      - name: Checkout the repository
        uses: actions/checkout@v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          version: ${{ vars.UV_VERSION }}

      - name: Lint
        run: uv run ruff check

  type-check:
    runs-on: self-hosted

    steps:
      - name: Set up the repository
        uses: actions/checkout@v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          version: ${{ vars.UV_VERSION }}

      - name: Type check
        run: uv run mypy cbir tests

  test:
    runs-on: self-hosted

    steps:
      - name: Set up the repository
        uses: actions/checkout@v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          version: ${{ vars.UV_VERSION }}

      - name: Install test dependencies
        run: uv sync --group test

      - name: Pull test images
        run: |
          docker version
          docker pull registry.cytomine.org/docker/redis:7.2
          docker pull registry.cytomine.org/docker/testcontainers/ryuk:0.13.0

      - name: Run tests
        run: uv run pytest
        env:
          DATA_PATH: ./
          PROXY_CACHE: registry.cytomine.org/docker/
          RYUK_CONTAINER_IMAGE: registry.cytomine.org/docker/testcontainers/ryuk:0.13.0
          WEIGHTS: ./weights/resnet
